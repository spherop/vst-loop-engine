<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loop Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fd-bg': '#0a0a0a',
                        'fd-surface': '#111111',
                        'fd-card': '#161616',
                        'fd-border': '#2a2a2a',
                        'fd-accent': '#ff6b35',
                        'fd-accent-dim': '#cc5429',
                        'fd-text': '#888888',
                        'fd-text-dim': '#555555',
                        'fd-highlight': '#ff8c5a',
                    },
                    fontFamily: {
                        'display': ['Orbitron', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'SF Mono', 'Monaco', 'monospace'],
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Inline critical fonts */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;500;700&display=swap');

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #ff6b35; }

        /* Section glow on hover */
        .section-card {
            transition: all 0.2s ease;
        }
        .section-card:hover {
            border-color: #333;
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.05);
        }

        /* Loading screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loading-logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 32px;
            font-weight: 900;
            letter-spacing: 0.3em;
            color: #ff6b35;
            text-shadow: 0 0 30px rgba(255, 107, 53, 0.6);
            animation: pulse-glow 1.5s ease-in-out infinite;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #2a2a2a;
            border-top-color: #ff6b35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 24px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes pulse-glow {
            0%, 100% { text-shadow: 0 0 30px rgba(255, 107, 53, 0.6); }
            50% { text-shadow: 0 0 50px rgba(255, 107, 53, 0.9); }
        }
    </style>
</head>
<body class="bg-fd-bg text-white font-sans h-screen overflow-hidden select-none">
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-logo">LOOP</div>
        <div class="text-fd-text-dim font-display text-xs tracking-[0.4em] mt-2">ENGINE</div>
        <div class="loading-spinner"></div>
    </div>

    <div id="main-content" class="flex flex-col h-full" style="opacity: 0; transition: opacity 0.3s ease;">
        <!-- Header with Logo and Tabs -->
        <header class="flex items-center justify-between px-4 py-2 border-b border-fd-border">
            <!-- Logo (left) -->
            <div class="flex items-baseline gap-1">
                <h1 class="font-display text-lg font-black tracking-[0.3em] text-fd-accent uppercase"
                    style="text-shadow: 0 0 20px rgba(255, 107, 53, 0.4);">
                    LOOP
                </h1>
                <span class="font-display text-[9px] font-bold tracking-[0.4em] text-fd-text-dim uppercase">
                    ENGINE
                </span>
            </div>

            <!-- Settings (right) - Loop Length, BPM, HOST sync, Version -->
            <div class="flex items-center gap-3">
                <!-- Loop Length Selector -->
                <div class="flex items-center gap-1">
                    <span class="font-display text-[7px] font-bold tracking-[1px] text-fd-text-dim uppercase">LEN</span>
                    <div class="flex flex-col gap-0.5">
                        <div class="flex items-center gap-1">
                            <select class="len-select" id="bars-select-header" title="Bars (0 = free mode)">
                                <option value="0">FREE</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="4">4</option>
                                <option value="8">8</option>
                                <option value="16">16</option>
                            </select>
                            <span class="font-display text-[6px] text-fd-text-dim">BAR</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <select class="len-select" id="beats-select-header" title="Additional beats">
                                <option value="0">+0</option>
                                <option value="1">+1</option>
                                <option value="2">+2</option>
                                <option value="3">+3</option>
                            </select>
                            <span class="font-display text-[6px] text-fd-text-dim">BEAT</span>
                        </div>
                    </div>
                </div>
                <!-- Divider -->
                <div class="w-[1px] h-8 bg-fd-border"></div>
                <!-- HOST toggle and division -->
                <div class="flex flex-col gap-0.5">
                    <button class="tempo-sync-btn" id="host-sync-btn-header" title="Sync looper to host transport">
                        <span class="tempo-sync-led" id="host-sync-led-header"></span>
                        <span class="tempo-sync-label">HOST</span>
                    </button>
                    <select class="tempo-division-select" id="note-value-select-header" disabled>
                        <option value="0">1/4</option>
                        <option value="1" selected>1/8</option>
                        <option value="2">1/8T</option>
                        <option value="3">1/16</option>
                        <option value="4">1/16T</option>
                        <option value="5">1/32</option>
                    </select>
                </div>
                <!-- BPM Display -->
                <div class="flex items-center gap-1">
                    <span class="font-mono text-sm font-bold text-fd-accent" id="bpm-display-header"
                          style="text-shadow: 0 0 10px rgba(255, 107, 53, 0.3);">120</span>
                    <span class="font-display text-[6px] text-fd-text-dim">BPM</span>
                </div>
                <!-- Divider -->
                <div class="w-[1px] h-8 bg-fd-border"></div>
                <!-- Version ticker -->
                <span class="font-mono text-[9px] text-fd-text-dim" id="version-ticker">v12.4.3</span>
            </div>
        </header>

        <!-- Main Content - Two Column Layout -->
        <main class="flex-1 flex gap-3 px-3 py-3 overflow-hidden">

            <!-- LOOPER Tab Content -->
            <div id="looper-tab" class="tab-content active flex gap-3 w-full">

                <!-- LEFT COLUMN: Looper Controls -->
                <div class="flex-1 flex flex-col gap-3 min-w-0">

                    <!-- Transport Controls (fixed height) -->
                    <section class="section-card bg-fd-card rounded-lg border border-fd-border p-3 flex-shrink-0">
                        <div class="flex justify-between items-center gap-3">
                            <!-- Left side: Input + Transport buttons -->
                            <div class="flex items-center gap-2">
                                <!-- Input Level Meter and Mute (vertical) -->
                                <div class="input-monitor-v flex flex-col items-center gap-1 mr-1">
                                    <div class="input-meter-v-container" title="Input Level (L/R)">
                                        <div class="input-meter-v-track">
                                            <div id="input-meter-bar-l" class="input-meter-v-bar left"></div>
                                        </div>
                                        <div class="input-meter-v-track">
                                            <div id="input-meter-bar-r" class="input-meter-v-bar right"></div>
                                        </div>
                                    </div>
                                    <button id="input-mute-btn" class="input-mute-btn-v" title="Mute Input">
                                        <span class="mute-label">IN</span>
                                    </button>
                                </div>
                                <button id="rec-btn" class="transport-btn rec rec-wide">
                                    <span class="transport-icon">&#9679;</span>
                                    <span class="transport-label">REC T1</span>
                                </button>
                                <button id="loop-play-btn" class="transport-btn play">
                                    <span class="transport-icon">&#9658;</span>
                                    <span class="transport-label">PLAY</span>
                                </button>
                                <button id="loop-stop-btn" class="transport-btn stop">
                                    <span class="transport-icon">&#9632;</span>
                                    <span class="transport-label">STOP</span>
                                </button>
                                <button id="reverse-btn" class="transport-btn reverse" title="Global reverse playback">
                                    <span class="transport-icon">&#8634;</span>
                                    <span class="transport-label">REV</span>
                                </button>
                                <button id="clear-btn" class="transport-btn clear" title="Clear all layers">
                                    <span class="transport-icon">&#10005;</span>
                                    <span class="transport-label">CLR</span>
                                </button>
                                <!-- ADD+ button (hidden for now) -->
                                <button id="add-btn" class="transport-btn add-btn hidden" title="Additive Recording - hold to compound effects through loop">
                                    <span class="transport-icon">+</span>
                                    <span class="transport-label">ADD</span>
                                </button>
                                <!-- UNDO/REDO buttons (hidden - using LAYERS knob instead) -->
                                <div class="flex flex-col gap-0.5 mr-2 hidden">
                                    <button id="undo-btn" class="transport-btn-stacked" title="Undo last layer">
                                        <span class="transport-icon-stacked">&#8617;</span>
                                    </button>
                                    <button id="redo-btn" class="transport-btn-stacked" title="Redo layer">
                                        <span class="transport-icon-stacked">&#8618;</span>
                                    </button>
                                </div>
                                <!-- Divider -->
                                <div class="w-[1px] h-10 bg-fd-border mx-1"></div>
                                <!-- Global Loop Controls (moved from bottom section) -->
                                <div class="flex items-center gap-4">
                                    <!-- SPEED -->
                                    <div class="flex flex-col items-center gap-0.5 relative" id="speed-control">
                                        <div class="knob knob-loop-small" id="loopSpeed-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="transport-knob-value" id="loopSpeed-value">100%</span>
                                        <span class="transport-knob-label">SPEED</span>
                                    </div>
                                    <!-- PITCH -->
                                    <div class="flex flex-col items-center gap-0.5 relative" id="pitch-control">
                                        <div class="knob knob-loop-small" id="loopPitch-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="transport-knob-value" id="loopPitch-value">0st</span>
                                        <span class="transport-knob-label">PITCH</span>
                                    </div>
                                    <!-- LAYERS -->
                                    <div class="flex flex-col items-center gap-0.5">
                                        <div class="knob knob-loop-small" id="layerDepth-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="transport-knob-value" id="layerDepth-value">ALL</span>
                                        <span class="transport-knob-label">LAYERS</span>
                                    </div>
                                    <!-- FADE -->
                                    <div class="flex flex-col items-center gap-0.5">
                                        <div class="knob knob-loop-small" id="loopFade-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="transport-knob-value" id="loopFade-value">100%</span>
                                        <span class="transport-knob-label">FADE</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Waveform/Mixer Display (fills remaining space) -->
                    <section class="section-card bg-fd-card rounded-lg border border-fd-border p-3 flex-1 flex flex-col min-h-0">
                        <!-- View Toggle Header -->
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <button class="view-toggle-btn active" id="waveform-view-btn" title="Waveform view">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M2 12h4l3-9 4 18 3-9h4"/>
                                    </svg>
                                </button>
                                <button class="view-toggle-btn" id="mixer-view-btn" title="Mixer view">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="4" y="4" width="4" height="16" rx="1"/>
                                        <rect x="10" y="8" width="4" height="12" rx="1"/>
                                        <rect x="16" y="2" width="4" height="18" rx="1"/>
                                    </svg>
                                </button>
                            </div>
                            <span class="font-display text-[7px] font-bold tracking-[2px] text-fd-text-dim uppercase" id="view-label">WAVEFORM</span>
                        </div>

                        <!-- WAVEFORM VIEW -->
                        <div class="waveform-wrapper flex gap-2 flex-1" id="waveform-view">
                            <div class="waveform-container flex-1" id="waveform-container">
                                <canvas id="waveform-canvas" class="waveform-canvas"></canvas>
                                <!-- Loop region shading -->
                                <div id="loop-region-shade" class="loop-region-shade"></div>
                                <div id="playhead" class="playhead"></div>
                                <div id="loop-region" class="loop-region">
                                    <div id="loop-start-handle" class="loop-handle start"></div>
                                    <div id="loop-end-handle" class="loop-handle end"></div>
                                </div>
                                <!-- Recording indicator overlay -->
                                <div id="recording-overlay" class="recording-overlay hidden">
                                    <div class="recording-indicator">
                                        <span class="rec-dot"></span>
                                        <span class="rec-text">RECORDING</span>
                                        <span id="rec-time" class="rec-time">0.0s</span>
                                    </div>
                                    <div id="input-level" class="input-level-meter">
                                        <div id="input-level-bar" class="input-level-bar"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Vertical Spread Slider - matches waveform height -->
                            <div class="spread-slider-v">
                                <span class="font-display text-[6px] font-bold tracking-[1px] text-fd-text-dim uppercase">SPR</span>
                                <input type="range" id="layer-spread-slider" min="0" max="100" value="0"
                                       class="layer-spread-slider-v" title="Spread layers vertically" orient="vertical">
                            </div>
                        </div>

                        <!-- MIXER VIEW -->
                        <div class="mixer-view hidden flex-1" id="mixer-view">
                            <div class="mixer-channels">
                                <!-- Channel strips will be generated dynamically -->
                                <div class="mixer-channel" data-layer="1">
                                    <div class="channel-label">1</div>
                                    <div class="channel-vu">
                                        <div class="vu-meter">
                                            <div class="vu-needle" id="vu-needle-1"></div>
                                            <div class="vu-scale">
                                                <span class="vu-mark" style="--angle: -45deg">-20</span>
                                                <span class="vu-mark" style="--angle: -22deg">-10</span>
                                                <span class="vu-mark" style="--angle: 0deg">0</span>
                                                <span class="vu-mark vu-red" style="--angle: 22deg">+3</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="channel-fader">
                                        <div class="fader-scale">
                                            <span class="fader-mark fader-mark-red">+3</span>
                                            <span class="fader-mark fader-mark-yellow">0</span>
                                            <span class="fader-mark fader-mark-green">-10</span>
                                            <span class="fader-mark fader-mark-green">-20</span>
                                            <span class="fader-mark">-inf</span>
                                        </div>
                                        <input type="range" class="fader" id="fader-1" min="0" max="127" value="100" orient="vertical">
                                        <div class="fader-track">
                                            <div class="fader-zone fader-zone-red"></div>
                                            <div class="fader-zone fader-zone-yellow"></div>
                                            <div class="fader-zone fader-zone-green"></div>
                                            <div class="fader-meter" id="fader-meter-1"></div>
                                        </div>
                                    </div>
                                    <div class="channel-pan">
                                        <div class="pan-knob" id="pan-knob-1">
                                            <div class="pan-indicator"></div>
                                        </div>
                                    </div>
                                    <div class="channel-buttons">
                                        <button class="channel-mute" id="mute-1" title="Mute">M</button>
                                        <button class="channel-solo" id="solo-1" title="Solo">S</button>
                                    </div>
                                </div>
                                <div class="mixer-channel" data-layer="2">
                                    <div class="channel-label">2</div>
                                    <div class="channel-vu">
                                        <div class="vu-meter">
                                            <div class="vu-needle" id="vu-needle-2"></div>
                                            <div class="vu-scale">
                                                <span class="vu-mark" style="--angle: -45deg">-20</span>
                                                <span class="vu-mark" style="--angle: -22deg">-10</span>
                                                <span class="vu-mark" style="--angle: 0deg">0</span>
                                                <span class="vu-mark vu-red" style="--angle: 22deg">+3</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="channel-fader">
                                        <div class="fader-scale">
                                            <span class="fader-mark fader-mark-red">+3</span>
                                            <span class="fader-mark fader-mark-yellow">0</span>
                                            <span class="fader-mark fader-mark-green">-10</span>
                                            <span class="fader-mark fader-mark-green">-20</span>
                                            <span class="fader-mark">-inf</span>
                                        </div>
                                        <input type="range" class="fader" id="fader-2" min="0" max="127" value="100" orient="vertical">
                                        <div class="fader-track">
                                            <div class="fader-zone fader-zone-red"></div>
                                            <div class="fader-zone fader-zone-yellow"></div>
                                            <div class="fader-zone fader-zone-green"></div>
                                            <div class="fader-meter" id="fader-meter-2"></div>
                                        </div>
                                    </div>
                                    <div class="channel-pan">
                                        <div class="pan-knob" id="pan-knob-2">
                                            <div class="pan-indicator"></div>
                                        </div>
                                    </div>
                                    <div class="channel-buttons">
                                        <button class="channel-mute" id="mute-2" title="Mute">M</button>
                                        <button class="channel-solo" id="solo-2" title="Solo">S</button>
                                    </div>
                                </div>
                                <div class="mixer-channel" data-layer="3">
                                    <div class="channel-label">3</div>
                                    <div class="channel-vu">
                                        <div class="vu-meter">
                                            <div class="vu-needle" id="vu-needle-3"></div>
                                            <div class="vu-scale">
                                                <span class="vu-mark" style="--angle: -45deg">-20</span>
                                                <span class="vu-mark" style="--angle: -22deg">-10</span>
                                                <span class="vu-mark" style="--angle: 0deg">0</span>
                                                <span class="vu-mark vu-red" style="--angle: 22deg">+3</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="channel-fader">
                                        <div class="fader-scale">
                                            <span class="fader-mark fader-mark-red">+3</span>
                                            <span class="fader-mark fader-mark-yellow">0</span>
                                            <span class="fader-mark fader-mark-green">-10</span>
                                            <span class="fader-mark fader-mark-green">-20</span>
                                            <span class="fader-mark">-inf</span>
                                        </div>
                                        <input type="range" class="fader" id="fader-3" min="0" max="127" value="100" orient="vertical">
                                        <div class="fader-track">
                                            <div class="fader-zone fader-zone-red"></div>
                                            <div class="fader-zone fader-zone-yellow"></div>
                                            <div class="fader-zone fader-zone-green"></div>
                                            <div class="fader-meter" id="fader-meter-3"></div>
                                        </div>
                                    </div>
                                    <div class="channel-pan">
                                        <div class="pan-knob" id="pan-knob-3">
                                            <div class="pan-indicator"></div>
                                        </div>
                                    </div>
                                    <div class="channel-buttons">
                                        <button class="channel-mute" id="mute-3" title="Mute">M</button>
                                        <button class="channel-solo" id="solo-3" title="Solo">S</button>
                                    </div>
                                </div>
                                <div class="mixer-channel" data-layer="4">
                                    <div class="channel-label">4</div>
                                    <div class="channel-vu">
                                        <div class="vu-meter">
                                            <div class="vu-needle" id="vu-needle-4"></div>
                                            <div class="vu-scale">
                                                <span class="vu-mark" style="--angle: -45deg">-20</span>
                                                <span class="vu-mark" style="--angle: -22deg">-10</span>
                                                <span class="vu-mark" style="--angle: 0deg">0</span>
                                                <span class="vu-mark vu-red" style="--angle: 22deg">+3</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="channel-fader">
                                        <div class="fader-scale">
                                            <span class="fader-mark fader-mark-red">+3</span>
                                            <span class="fader-mark fader-mark-yellow">0</span>
                                            <span class="fader-mark fader-mark-green">-10</span>
                                            <span class="fader-mark fader-mark-green">-20</span>
                                            <span class="fader-mark">-inf</span>
                                        </div>
                                        <input type="range" class="fader" id="fader-4" min="0" max="127" value="100" orient="vertical">
                                        <div class="fader-track">
                                            <div class="fader-zone fader-zone-red"></div>
                                            <div class="fader-zone fader-zone-yellow"></div>
                                            <div class="fader-zone fader-zone-green"></div>
                                            <div class="fader-meter" id="fader-meter-4"></div>
                                        </div>
                                    </div>
                                    <div class="channel-pan">
                                        <div class="pan-knob" id="pan-knob-4">
                                            <div class="pan-indicator"></div>
                                        </div>
                                    </div>
                                    <div class="channel-buttons">
                                        <button class="channel-mute" id="mute-4" title="Mute">M</button>
                                        <button class="channel-solo" id="solo-4" title="Solo">S</button>
                                    </div>
                                </div>
                                <div class="mixer-channel" data-layer="5">
                                    <div class="channel-label">5</div>
                                    <div class="channel-vu">
                                        <div class="vu-meter">
                                            <div class="vu-needle" id="vu-needle-5"></div>
                                            <div class="vu-scale">
                                                <span class="vu-mark" style="--angle: -45deg">-20</span>
                                                <span class="vu-mark" style="--angle: -22deg">-10</span>
                                                <span class="vu-mark" style="--angle: 0deg">0</span>
                                                <span class="vu-mark vu-red" style="--angle: 22deg">+3</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="channel-fader">
                                        <div class="fader-scale">
                                            <span class="fader-mark fader-mark-red">+3</span>
                                            <span class="fader-mark fader-mark-yellow">0</span>
                                            <span class="fader-mark fader-mark-green">-10</span>
                                            <span class="fader-mark fader-mark-green">-20</span>
                                            <span class="fader-mark">-inf</span>
                                        </div>
                                        <input type="range" class="fader" id="fader-5" min="0" max="127" value="100" orient="vertical">
                                        <div class="fader-track">
                                            <div class="fader-zone fader-zone-red"></div>
                                            <div class="fader-zone fader-zone-yellow"></div>
                                            <div class="fader-zone fader-zone-green"></div>
                                            <div class="fader-meter" id="fader-meter-5"></div>
                                        </div>
                                    </div>
                                    <div class="channel-pan">
                                        <div class="pan-knob" id="pan-knob-5">
                                            <div class="pan-indicator"></div>
                                        </div>
                                    </div>
                                    <div class="channel-buttons">
                                        <button class="channel-mute" id="mute-5" title="Mute">M</button>
                                        <button class="channel-solo" id="solo-5" title="Solo">S</button>
                                    </div>
                                </div>
                                <div class="mixer-channel" data-layer="6">
                                    <div class="channel-label">6</div>
                                    <div class="channel-vu">
                                        <div class="vu-meter">
                                            <div class="vu-needle" id="vu-needle-6"></div>
                                            <div class="vu-scale">
                                                <span class="vu-mark" style="--angle: -45deg">-20</span>
                                                <span class="vu-mark" style="--angle: -22deg">-10</span>
                                                <span class="vu-mark" style="--angle: 0deg">0</span>
                                                <span class="vu-mark vu-red" style="--angle: 22deg">+3</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="channel-fader">
                                        <div class="fader-scale">
                                            <span class="fader-mark fader-mark-red">+3</span>
                                            <span class="fader-mark fader-mark-yellow">0</span>
                                            <span class="fader-mark fader-mark-green">-10</span>
                                            <span class="fader-mark fader-mark-green">-20</span>
                                            <span class="fader-mark">-inf</span>
                                        </div>
                                        <input type="range" class="fader" id="fader-6" min="0" max="127" value="100" orient="vertical">
                                        <div class="fader-track">
                                            <div class="fader-zone fader-zone-red"></div>
                                            <div class="fader-zone fader-zone-yellow"></div>
                                            <div class="fader-zone fader-zone-green"></div>
                                            <div class="fader-meter" id="fader-meter-6"></div>
                                        </div>
                                    </div>
                                    <div class="channel-pan">
                                        <div class="pan-knob" id="pan-knob-6">
                                            <div class="pan-indicator"></div>
                                        </div>
                                    </div>
                                    <div class="channel-buttons">
                                        <button class="channel-mute" id="mute-6" title="Mute">M</button>
                                        <button class="channel-solo" id="solo-6" title="Solo">S</button>
                                    </div>
                                </div>
                                <div class="mixer-channel" data-layer="7">
                                    <div class="channel-label">7</div>
                                    <div class="channel-vu">
                                        <div class="vu-meter">
                                            <div class="vu-needle" id="vu-needle-7"></div>
                                            <div class="vu-scale">
                                                <span class="vu-mark" style="--angle: -45deg">-20</span>
                                                <span class="vu-mark" style="--angle: -22deg">-10</span>
                                                <span class="vu-mark" style="--angle: 0deg">0</span>
                                                <span class="vu-mark vu-red" style="--angle: 22deg">+3</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="channel-fader">
                                        <div class="fader-scale">
                                            <span class="fader-mark fader-mark-red">+3</span>
                                            <span class="fader-mark fader-mark-yellow">0</span>
                                            <span class="fader-mark fader-mark-green">-10</span>
                                            <span class="fader-mark fader-mark-green">-20</span>
                                            <span class="fader-mark">-inf</span>
                                        </div>
                                        <input type="range" class="fader" id="fader-7" min="0" max="127" value="100" orient="vertical">
                                        <div class="fader-track">
                                            <div class="fader-zone fader-zone-red"></div>
                                            <div class="fader-zone fader-zone-yellow"></div>
                                            <div class="fader-zone fader-zone-green"></div>
                                            <div class="fader-meter" id="fader-meter-7"></div>
                                        </div>
                                    </div>
                                    <div class="channel-pan">
                                        <div class="pan-knob" id="pan-knob-7">
                                            <div class="pan-indicator"></div>
                                        </div>
                                    </div>
                                    <div class="channel-buttons">
                                        <button class="channel-mute" id="mute-7" title="Mute">M</button>
                                        <button class="channel-solo" id="solo-7" title="Solo">S</button>
                                    </div>
                                </div>
                                <div class="mixer-channel" data-layer="8">
                                    <div class="channel-label">8</div>
                                    <div class="channel-vu">
                                        <div class="vu-meter">
                                            <div class="vu-needle" id="vu-needle-8"></div>
                                            <div class="vu-scale">
                                                <span class="vu-mark" style="--angle: -45deg">-20</span>
                                                <span class="vu-mark" style="--angle: -22deg">-10</span>
                                                <span class="vu-mark" style="--angle: 0deg">0</span>
                                                <span class="vu-mark vu-red" style="--angle: 22deg">+3</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="channel-fader">
                                        <div class="fader-scale">
                                            <span class="fader-mark fader-mark-red">+3</span>
                                            <span class="fader-mark fader-mark-yellow">0</span>
                                            <span class="fader-mark fader-mark-green">-10</span>
                                            <span class="fader-mark fader-mark-green">-20</span>
                                            <span class="fader-mark">-inf</span>
                                        </div>
                                        <input type="range" class="fader" id="fader-8" min="0" max="127" value="100" orient="vertical">
                                        <div class="fader-track">
                                            <div class="fader-zone fader-zone-red"></div>
                                            <div class="fader-zone fader-zone-yellow"></div>
                                            <div class="fader-zone fader-zone-green"></div>
                                            <div class="fader-meter" id="fader-meter-8"></div>
                                        </div>
                                    </div>
                                    <div class="channel-pan">
                                        <div class="pan-knob" id="pan-knob-8">
                                            <div class="pan-indicator"></div>
                                        </div>
                                    </div>
                                    <div class="channel-buttons">
                                        <button class="channel-mute" id="mute-8" title="Mute">M</button>
                                        <button class="channel-solo" id="solo-8" title="Solo">S</button>
                                    </div>
                                </div>
                                <!-- MixBus Channel -->
                                <div class="mixer-channel mixer-channel-bus" data-layer="bus">
                                    <div class="channel-label">MIX</div>
                                    <div class="channel-vu">
                                        <div class="vu-meter">
                                            <div class="vu-needle" id="vu-needle-bus"></div>
                                            <div class="vu-scale">
                                                <span class="vu-mark" style="--angle: -45deg">-20</span>
                                                <span class="vu-mark" style="--angle: -22deg">-10</span>
                                                <span class="vu-mark" style="--angle: 0deg">0</span>
                                                <span class="vu-mark vu-red" style="--angle: 22deg">+3</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="channel-fader">
                                        <div class="fader-scale">
                                            <span class="fader-mark fader-mark-red">+3</span>
                                            <span class="fader-mark fader-mark-yellow">0</span>
                                            <span class="fader-mark fader-mark-green">-10</span>
                                            <span class="fader-mark fader-mark-green">-20</span>
                                            <span class="fader-mark">-inf</span>
                                        </div>
                                        <input type="range" class="fader" id="fader-bus" min="0" max="127" value="100" orient="vertical" disabled>
                                        <div class="fader-track">
                                            <div class="fader-zone fader-zone-red"></div>
                                            <div class="fader-zone fader-zone-yellow"></div>
                                            <div class="fader-zone fader-zone-green"></div>
                                            <div class="fader-meter" id="fader-meter-bus"></div>
                                        </div>
                                    </div>
                                    <div class="channel-pan">
                                        <div class="pan-knob pan-knob-disabled" id="pan-knob-bus">
                                            <div class="pan-indicator"></div>
                                        </div>
                                    </div>
                                    <div class="channel-buttons">
                                        <button class="channel-mute" id="mute-bus" title="Mute MixBus">M</button>
                                        <button class="channel-clear" id="clear-bus" title="Clear MixBus">C</button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </section>

                    <!-- Layer Controls (fixed at bottom) -->
                    <section class="section-card bg-fd-card rounded-lg border border-fd-border p-2 flex-shrink-0">
                        <div class="flex justify-between items-center">
                            <!-- Layer Indicators (left) -->
                            <div class="flex items-center gap-2">
                                <span class="font-display text-[8px] font-bold tracking-[2px] text-fd-text-dim uppercase" id="layer-mode-label">LAYER</span>
                                <div class="layer-indicators flex gap-1.5">
                                    <button class="layer-btn layer-btn-large active" data-layer="1">1</button>
                                    <button class="layer-btn layer-btn-large" data-layer="2">2</button>
                                    <button class="layer-btn layer-btn-large" data-layer="3">3</button>
                                    <button class="layer-btn layer-btn-large" data-layer="4">4</button>
                                    <button class="layer-btn layer-btn-large" data-layer="5">5</button>
                                    <button class="layer-btn layer-btn-large" data-layer="6">6</button>
                                    <button class="layer-btn layer-btn-large" data-layer="7">7</button>
                                    <button class="layer-btn layer-btn-large" data-layer="8">8</button>
                                </div>
                                <span class="master-level-indicator" id="master-level-indicator" title="Master output level"></span>
                                <button class="flatten-btn" id="flatten-btn" title="Flatten all unmuted layers into layer 1">
                                    <svg class="flatten-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="7" height="7" rx="1" opacity="0.5"/>
                                        <rect x="14" y="3" width="7" height="7" rx="1" opacity="0.5"/>
                                        <rect x="3" y="14" width="7" height="7" rx="1" opacity="0.5"/>
                                        <rect x="14" y="14" width="7" height="7" rx="1" opacity="0.5"/>
                                        <path d="M12 8 L12 16" stroke-width="2.5"/>
                                        <path d="M8 12 L16 12" stroke-width="2.5"/>
                                        <circle cx="12" cy="12" r="3" fill="currentColor" stroke="none"/>
                                    </svg>
                                </button>
                                <!-- Track/Layer Mode Toggle -->
                                <div class="mode-toggle-switch" id="mode-toggle-btn" title="Toggle Track/Layer Mode - Track: layers sum together | Layer: higher layers override">
                                    <div class="mode-track-indicator"></div>
                                    <div class="mode-labels">
                                        <span class="mode-label" id="mode-track">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                                <path d="M4 6h16M4 12h16M4 18h16"/>
                                            </svg>
                                            <span>TRK</span>
                                        </span>
                                        <span class="mode-label" id="mode-layer">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                                                <path d="M2 12l10 5 10-5" opacity="0.7"/>
                                                <path d="M2 17l10 5 10-5" opacity="0.4"/>
                                            </svg>
                                            <span>LYR</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- Loop time + Crossfade (right) -->
                            <div class="flex items-center gap-2">
                                <span id="loop-time-display" class="font-mono text-[10px] font-bold text-fd-text"
                                      style="text-shadow: 0 0 6px rgba(79, 195, 247, 0.2);">0.0s</span>
                                <button class="xfade-settings-btn" id="xfade-settings-btn" title="Loop crossfade settings">
                                    <span class="xfade-icon">&#8734;</span>
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- Per-Layer Control Panel (slides down when layer selected) -->
                    <div class="layer-control-panel hidden" id="layer-control-panel">
                        <div class="layer-panel-header">
                            <span class="layer-panel-title" id="layer-panel-title">LAYER <span id="layer-panel-num">1</span></span>
                            <button class="layer-panel-close" id="layer-panel-close" title="Close">&times;</button>
                        </div>
                        <div class="layer-panel-content">
                            <!-- Controls Row -->
                            <div class="layer-controls-row">
                                <!-- Volume Fader Section -->
                                <div class="layer-volume-section">
                                    <span class="layer-section-label">VOL</span>
                                    <div class="layer-fader-container">
                                        <div class="layer-fader-scale">
                                            <span class="layer-fader-mark layer-fader-mark-red">+3</span>
                                            <span class="layer-fader-mark layer-fader-mark-yellow">0</span>
                                            <span class="layer-fader-mark layer-fader-mark-green">-10</span>
                                            <span class="layer-fader-mark layer-fader-mark-dim">-20</span>
                                        </div>
                                        <div class="layer-fader-track">
                                            <div class="layer-fader-zone layer-fader-zone-red"></div>
                                            <div class="layer-fader-zone layer-fader-zone-yellow"></div>
                                            <div class="layer-fader-zone layer-fader-zone-green"></div>
                                            <div class="layer-fader-meter" id="layer-fader-meter"></div>
                                            <div class="layer-fader-unity"></div>
                                        </div>
                                        <input type="range" class="layer-fader" id="layer-volume-fader" min="0" max="127" value="100" orient="vertical">
                                        <span class="layer-fader-value" id="layer-volume-value">0 dB</span>
                                    </div>
                                </div>

                                <!-- Mute/Solo/Pan Section -->
                                <div class="layer-channel-section">
                                    <div class="layer-channel-buttons">
                                        <button class="layer-mute-btn" id="layer-mute-btn" title="Mute layer">M</button>
                                        <button class="layer-solo-btn" id="layer-solo-btn" title="Solo layer">S</button>
                                    </div>
                                    <div class="layer-pan-group">
                                        <span class="layer-knob-label">PAN</span>
                                        <div class="layer-pan-knob" id="layer-pan-knob">
                                            <div class="layer-pan-indicator"></div>
                                        </div>
                                        <span class="layer-pan-value" id="layer-pan-value">C</span>
                                    </div>
                                </div>

                                <!-- 3-Band EQ -->
                                <div class="layer-eq-section">
                                    <span class="layer-section-label">EQ</span>
                                    <div class="layer-eq-knobs">
                                        <div class="layer-knob-group">
                                            <div class="layer-knob" id="layer-eq-low" data-band="low">
                                                <div class="layer-knob-indicator"></div>
                                            </div>
                                            <span class="layer-knob-label">LOW</span>
                                            <span class="layer-knob-value" id="layer-eq-low-value">0dB</span>
                                        </div>
                                        <div class="layer-knob-group">
                                            <div class="layer-knob" id="layer-eq-mid" data-band="mid">
                                                <div class="layer-knob-indicator"></div>
                                            </div>
                                            <span class="layer-knob-label">MID</span>
                                            <span class="layer-knob-value" id="layer-eq-mid-value">0dB</span>
                                        </div>
                                        <div class="layer-knob-group">
                                            <div class="layer-knob" id="layer-eq-high" data-band="high">
                                                <div class="layer-knob-indicator"></div>
                                            </div>
                                            <span class="layer-knob-label">HIGH</span>
                                            <span class="layer-knob-value" id="layer-eq-high-value">0dB</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Per-Layer Pitch -->
                                <div class="layer-pitch-section">
                                    <span class="layer-section-label">PITCH</span>
                                    <div class="layer-pitch-controls">
                                        <div class="layer-knob-group">
                                            <div class="layer-knob layer-pitch-knob" id="layer-pitch-knob">
                                                <div class="layer-knob-indicator"></div>
                                            </div>
                                            <span class="layer-knob-value" id="layer-pitch-value">0 st</span>
                                        </div>
                                        <button class="layer-pitch-hq-btn" id="layer-pitch-hq-btn" title="High Quality pitch shifting (higher CPU)">
                                            HQ
                                        </button>
                                    </div>
                                </div>

                                <!-- Reverse Toggle -->
                                <div class="layer-reverse-section">
                                    <button class="layer-reverse-btn" id="layer-reverse-btn">
                                        <span class="reverse-icon">&#x21BA;</span>
                                        REV
                                    </button>
                                </div>

                                <!-- Delete Button -->
                                <div class="layer-delete-section">
                                    <button class="layer-delete-btn" id="layer-delete-btn" title="Clear layer">
                                        <span class="delete-icon">&#x1F5D1;</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- RIGHT COLUMN: Effects Rack -->
                <div class="w-64 flex flex-col" id="effects-rack">
                    <section class="section-card bg-fd-card rounded-lg border border-fd-border flex-1 flex flex-col overflow-hidden">
                        <!-- Rack Header -->
                        <div class="flex items-center justify-between p-3 border-b border-fd-border">
                            <div class="flex items-center gap-2">
                                <span class="font-display text-[9px] font-bold tracking-[2px] text-fd-text-dim uppercase">EFFECTS</span>
                            </div>
                            <button class="rack-back-btn hidden" id="rack-back-btn" title="Back to rack overview">
                                <span class="back-icon">&larr;</span>
                                <span class="back-label">BACK</span>
                            </button>
                        </div>

                        <!-- RACK OVERVIEW (Pedal Cards) -->
                        <div class="rack-overview flex-1 overflow-y-auto p-2 flex flex-col gap-2" id="rack-overview">

                            <!-- SATURATION Pedal Card -->
                            <div class="pedal-card saturation-card" id="saturation-card" data-effect="saturation">
                                <div class="pedal-header">
                                    <div class="flex items-center gap-2">
                                        <div class="section-led saturation-led" id="saturation-led"></div>
                                        <span class="pedal-name">SATURATION</span>
                                        <button class="pedal-expand-btn" data-effect="saturation" title="Open full panel">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M9 18l6-6-6-6"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <div class="knob knob-micro saturation-knob" id="satMix-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="font-mono text-[8px] text-white w-[28px] text-right" id="satMix-value">100%</span>
                                    </div>
                                </div>
                                <div class="pedal-params">
                                    <div class="pedal-param">
                                        <div class="knob knob-micro saturation-knob" id="satDrive-card-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="pedal-param-label">DRIVE</span>
                                    </div>
                                    <div class="pedal-param">
                                        <span class="sat-type-indicator font-mono text-[9px] text-fd-accent" id="sat-type-card">SOFT</span>
                                        <span class="pedal-param-label">TYPE</span>
                                    </div>
                                </div>
                            </div>

                            <!-- LOFI Pedal Card -->
                            <div class="pedal-card lofi-card" id="lofi-card" data-effect="lofi">
                                <div class="pedal-header">
                                    <div class="flex items-center gap-2">
                                        <div class="section-led lofi-led active" id="lofi-master-led"></div>
                                        <span class="pedal-name">LOFI</span>
                                        <button class="pedal-expand-btn" data-effect="lofi" title="Open full panel">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M9 18l6-6-6-6"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <div class="knob knob-micro lofi-knob" id="lofiMix-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="font-mono text-[8px] text-white w-[28px] text-right" id="lofiMix-value">100%</span>
                                    </div>
                                </div>
                                <div class="pedal-params">
                                    <div class="pedal-param">
                                        <div class="knob knob-micro lofi-knob" id="lofiBit-card-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="pedal-param-label">BIT</span>
                                    </div>
                                    <div class="pedal-param">
                                        <div class="knob knob-micro lofi-knob" id="lofiWobble-card-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="pedal-param-label">WOB</span>
                                    </div>
                                    <div class="pedal-param">
                                        <div class="knob knob-micro lofi-knob" id="lofiVinyl-card-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="pedal-param-label">VINYL</span>
                                    </div>
                                    <div class="pedal-param">
                                        <div class="knob knob-micro lofi-knob" id="lofiLP-card-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="pedal-param-label">LP</span>
                                    </div>
                                </div>
                            </div>

                            <!-- GRANULAR Pedal Card (Micro Looper) -->
                            <div class="pedal-card granular-card" id="granular-card" data-effect="granular">
                                <div class="pedal-header">
                                    <div class="flex items-center gap-2">
                                        <div class="section-led granular-led" id="granular-led"></div>
                                        <span class="pedal-name">MICRO LOOP</span>
                                        <button class="pedal-expand-btn" data-effect="granular" title="Open full panel">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M9 18l6-6-6-6"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <div class="knob knob-micro granular-knob" id="microMix-card-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="font-mono text-[8px] text-white w-[28px] text-right" id="microMix-card-value">50%</span>
                                    </div>
                                </div>
                                <!-- Mini waveform visualization -->
                                <div class="granular-viz-container">
                                    <canvas id="granular-card-canvas" class="granular-card-canvas"></canvas>
                                    <div class="granular-status" id="granular-status">IDLE</div>
                                </div>
                                <div class="pedal-params">
                                    <div class="pedal-param">
                                        <div class="knob knob-micro granular-knob" id="microSpeed-card-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="pedal-param-label">SPEED</span>
                                    </div>
                                    <div class="pedal-param">
                                        <div class="knob knob-micro granular-knob" id="microModify-card-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="pedal-param-label">MOD</span>
                                    </div>
                                </div>
                            </div>

                            <!-- REVERB Pedal Card -->
                            <div class="pedal-card reverb-card" id="reverb-card" data-effect="reverb">
                                <div class="pedal-header">
                                    <div class="flex items-center gap-2">
                                        <div class="section-led reverb-led" id="reverb-led"></div>
                                        <span class="pedal-name">REVERB</span>
                                        <button class="pedal-expand-btn" data-effect="reverb" title="Open full panel">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M9 18l6-6-6-6"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <div class="knob knob-micro reverb-knob" id="reverbMix-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="font-mono text-[8px] text-white w-[28px] text-right" id="reverbMix-value">30%</span>
                                    </div>
                                </div>
                                <div class="pedal-params">
                                    <div class="pedal-param">
                                        <div class="knob knob-micro reverb-knob" id="reverbDecay-card-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="pedal-param-label">DECAY</span>
                                    </div>
                                    <div class="pedal-param">
                                        <div class="knob knob-micro reverb-knob" id="reverbSize-card-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="pedal-param-label">SIZE</span>
                                    </div>
                                    <div class="pedal-param">
                                        <span class="reverb-type-indicator font-mono text-[9px] text-fd-accent" id="reverb-type-card">SPRING</span>
                                        <span class="pedal-param-label">TYPE</span>
                                    </div>
                                </div>
                            </div>

                            <!-- DELAY Pedal Card -->
                            <div class="pedal-card delay-card" id="delay-card" data-effect="delay">
                                <div class="pedal-header">
                                    <div class="flex items-center gap-2">
                                        <div class="section-led delay-led" id="delay-led"></div>
                                        <span class="pedal-name">DELAY</span>
                                        <button class="pedal-expand-btn" data-effect="delay" title="Open full panel">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M9 18l6-6-6-6"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <div class="knob knob-micro delay-knob" id="mix-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="font-mono text-[8px] text-white w-[28px] text-right" id="mix-value">50%</span>
                                    </div>
                                </div>
                                <div class="pedal-params">
                                    <div class="pedal-param">
                                        <div class="knob knob-micro delay-knob" id="delayTime-card-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="pedal-param-label">TIME</span>
                                    </div>
                                    <div class="pedal-param">
                                        <div class="knob knob-micro delay-knob" id="feedback-card-knob">
                                            <div class="knob-dot"></div>
                                        </div>
                                        <span class="pedal-param-label">FDBK</span>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- RACK DETAIL (Full Effect Views) -->
                        <div class="rack-detail hidden flex-1 overflow-y-auto" id="rack-detail">

                            <!-- SATURATION Detail View -->
                            <div class="effect-detail hidden" id="saturation-detail" data-effect="saturation">
                                <div class="p-3 border-b border-fd-border">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <div class="section-led saturation-led" id="saturation-detail-led"></div>
                                            <span class="font-display text-[8px] font-bold tracking-[1px] text-fd-text-dim uppercase">SATURATION</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <div class="knob knob-small saturation-knob" id="satMix-detail-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white w-[32px] text-right" id="satMix-detail-value">100%</span>
                                        </div>
                                    </div>

                                    <!-- Type Selector -->
                                    <div class="flex justify-center gap-1 mb-4">
                                        <button class="sat-type-btn active" data-type="0">SOFT</button>
                                        <button class="sat-type-btn" data-type="1">TAPE</button>
                                        <button class="sat-type-btn" data-type="2">TUBE</button>
                                        <button class="sat-type-btn" data-type="3">FUZZ</button>
                                    </div>

                                    <!-- SOFT Parameters -->
                                    <div class="sat-type-params" id="sat-soft-params">
                                        <div class="grid grid-cols-3 gap-3">
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satSoftDrive-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satSoftDrive-value">50%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">DRIVE</span>
                                            </div>
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satSoftTone-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satSoftTone-value">50%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">TONE</span>
                                            </div>
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satSoftCurve-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satSoftCurve-value">50%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">CURVE</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- TAPE Parameters -->
                                    <div class="sat-type-params hidden" id="sat-tape-params">
                                        <div class="grid grid-cols-4 gap-2">
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satTapeDrive-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satTapeDrive-value">50%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">DRIVE</span>
                                            </div>
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satTapeBias-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satTapeBias-value">50%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">BIAS</span>
                                            </div>
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satTapeFlutter-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satTapeFlutter-value">0%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">FLUTTER</span>
                                            </div>
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satTapeTone-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satTapeTone-value">50%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">TONE</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- TUBE Parameters -->
                                    <div class="sat-type-params hidden" id="sat-tube-params">
                                        <div class="grid grid-cols-4 gap-2">
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satTubeDrive-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satTubeDrive-value">50%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">DRIVE</span>
                                            </div>
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satTubeBias-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satTubeBias-value">50%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">BIAS</span>
                                            </div>
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satTubeWarmth-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satTubeWarmth-value">50%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">WARMTH</span>
                                            </div>
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satTubeSag-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satTubeSag-value">0%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">SAG</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- FUZZ Parameters -->
                                    <div class="sat-type-params hidden" id="sat-fuzz-params">
                                        <div class="grid grid-cols-4 gap-2">
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satFuzzDrive-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satFuzzDrive-value">50%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">DRIVE</span>
                                            </div>
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satFuzzGate-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satFuzzGate-value">0%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">GATE</span>
                                            </div>
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satFuzzOctave-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satFuzzOctave-value">0%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">OCTAVE</span>
                                            </div>
                                            <div class="flex flex-col items-center gap-1">
                                                <div class="knob knob-small saturation-knob" id="satFuzzTone-knob">
                                                    <div class="knob-dot"></div>
                                                </div>
                                                <span class="font-mono text-[9px] text-white" id="satFuzzTone-value">50%</span>
                                                <span class="font-display text-[7px] text-fd-text-dim">TONE</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- LOFI Detail View -->
                            <div class="effect-detail hidden" id="lofi-detail" data-effect="lofi">
                                <!-- LO-FI Section -->
                                <div class="p-3 border-b border-fd-border">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <div class="section-led lofi-led active" id="lofi-led"></div>
                                            <span class="font-display text-[8px] font-bold tracking-[1px] text-fd-text-dim uppercase">LO-FI</span>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-4 gap-2">
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small lofi-knob" id="lofiBit-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="lofiBit-value">16</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">BIT</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small lofi-knob" id="lofiSR-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="lofiSR-value">48k</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">SR</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small lofi-knob" id="lofiWobble-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="lofiWobble-value">0%</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">WOB</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small lofi-knob" id="lofiVinyl-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="lofiVinyl-value">0%</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">VINYL</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- FILTER Section -->
                                <div class="p-3">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <div class="section-led lofi-led active" id="filter-led"></div>
                                            <span class="font-display text-[8px] font-bold tracking-[1px] text-fd-text-dim uppercase">FILTER</span>
                                        </div>
                                    </div>
                                    <div class="filter-viz-container mb-3">
                                        <canvas id="filter-viz-canvas" class="filter-viz-canvas"></canvas>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="flex flex-col items-center gap-1" id="hp-group">
                                            <div class="knob knob-small lofi-knob" id="lofiHP-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="lofiHP-value">20Hz</span>
                                            <span class="filter-label font-display text-[7px] font-bold cursor-pointer active" id="hp-toggle-label" title="Toggle High-Pass">HP</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1" id="lp-group">
                                            <div class="knob knob-small lofi-knob" id="lofiLP-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="lofiLP-value">20kHz</span>
                                            <span class="filter-label font-display text-[7px] font-bold cursor-pointer active" id="lp-toggle-label" title="Toggle Low-Pass">LP</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- SUB BASS Section -->
                                <div class="p-3 border-t border-fd-border">
                                    <div class="flex items-center gap-2 mb-3">
                                        <div class="section-led lofi-led" id="subbass-led"></div>
                                        <span class="font-display text-[8px] font-bold tracking-[1px] text-fd-text-dim uppercase">SUB BASS</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small lofi-knob" id="subBassFreq-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="subBassFreq-value">55Hz</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">FREQ</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small lofi-knob" id="subBassAmount-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="subBassAmount-value">0%</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">AMOUNT</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- GRANULAR Detail View (Micro Looper) -->
                            <div class="effect-detail hidden" id="granular-detail" data-effect="granular">
                                <div class="p-3 border-b border-fd-border">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <div class="section-led granular-led" id="granular-detail-led"></div>
                                            <span class="font-display text-[8px] font-bold tracking-[1px] text-fd-text-dim uppercase">MICRO LOOPER</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <button class="micro-transport-btn" id="micro-play-btn" title="Play/Stop">
                                                <span class="micro-icon">&#9654;</span>
                                            </button>
                                            <button class="micro-transport-btn" id="micro-overdub-btn" title="Overdub">
                                                <span class="micro-icon">&#9673;</span>
                                            </button>
                                            <button class="micro-transport-btn" id="micro-freeze-btn" title="Freeze">
                                                <span class="micro-icon">&#10052;</span>
                                            </button>
                                            <button class="micro-transport-btn" id="micro-clear-btn" title="Clear">
                                                <span class="micro-icon">&#10005;</span>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Waveform -->
                                    <div class="micro-waveform-container mb-2">
                                        <canvas id="micro-waveform-canvas" class="micro-waveform-canvas"></canvas>
                                        <div class="micro-playhead" id="micro-playhead"></div>
                                        <div class="micro-buffer-fill" id="micro-buffer-fill"></div>
                                    </div>

                                    <!-- Mode selector -->
                                    <div class="flex justify-center gap-1 mb-2">
                                        <button class="micro-mode-btn" id="micro-mode-env" data-mode="0" title="Envelope mode">ENV</button>
                                        <button class="micro-mode-btn active" id="micro-mode-tape" data-mode="1" title="Tape mode">TAPE</button>
                                        <button class="micro-mode-btn" id="micro-mode-stretch" data-mode="2" title="Stretch mode">STR</button>
                                    </div>

                                    <!-- Scale selector for pitch quantization -->
                                    <div class="flex justify-center gap-1 mb-2">
                                        <button class="micro-scale-btn active" id="micro-scale-free" data-scale="0" title="Free - no quantization">FREE</button>
                                        <button class="micro-scale-btn" id="micro-scale-chrom" data-scale="1" title="Chromatic - all semitones">CHROM</button>
                                        <button class="micro-scale-btn" id="micro-scale-major" data-scale="2" title="Major scale">MAJ</button>
                                        <button class="micro-scale-btn" id="micro-scale-minor" data-scale="3" title="Minor scale">MIN</button>
                                        <button class="micro-scale-btn" id="micro-scale-penta" data-scale="4" title="Pentatonic">PENTA</button>
                                        <button class="micro-scale-btn" id="micro-scale-oct" data-scale="5" title="Octaves only">OCT</button>
                                    </div>

                                    <div class="text-center mb-2">
                                        <span class="font-mono text-[8px] text-fd-text-dim" id="micro-mode-desc">TAPE: Speed control with tape-like wow</span>
                                    </div>

                                    <div class="grid grid-cols-5 gap-2 mb-2">
                                        <div class="flex flex-col items-center gap-0.5">
                                            <div class="knob knob-tiny granular-knob" id="microClock-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[8px] text-white" id="microClock-value">8.0s</span>
                                            <span class="font-display text-[6px] text-fd-text-dim">CLOCK</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-0.5">
                                            <div class="knob knob-tiny granular-knob" id="microLength-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[8px] text-white" id="microLength-value">100%</span>
                                            <span class="font-display text-[6px] text-fd-text-dim">LENGTH</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-0.5">
                                            <div class="knob knob-tiny granular-knob" id="microSpeed-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[8px] text-white" id="microSpeed-value">1.0x</span>
                                            <span class="font-display text-[6px] text-fd-text-dim">SPEED</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-0.5">
                                            <div class="knob knob-tiny granular-knob" id="microModify-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[8px] text-white" id="microModify-value">50%</span>
                                            <span class="font-display text-[6px] text-fd-text-dim">MODIFY</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-0.5">
                                            <div class="knob knob-tiny granular-knob" id="microMix-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[8px] text-white" id="microMix-value">50%</span>
                                            <span class="font-display text-[6px] text-fd-text-dim">MIX</span>
                                        </div>
                                    </div>

                                    <div class="flex justify-center items-center">
                                        <button class="micro-reverse-btn" id="micro-reverse-btn" title="Reverse playback">
                                            <span class="reverse-icon">&#8634;</span>
                                            <span class="reverse-label">REVERSE</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- REVERB Detail View -->
                            <div class="effect-detail hidden" id="reverb-detail" data-effect="reverb">
                                <div class="p-3 border-b border-fd-border">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <div class="section-led reverb-led" id="reverb-detail-led"></div>
                                            <span class="font-display text-[8px] font-bold tracking-[1px] text-fd-text-dim uppercase">REVERB</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <div class="knob knob-small reverb-knob" id="reverbMix-detail-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white w-[32px] text-right" id="reverbMix-detail-value">30%</span>
                                        </div>
                                    </div>

                                    <!-- Algorithm Selector -->
                                    <div class="flex justify-center gap-1 mb-4">
                                        <button class="reverb-type-btn active" data-type="0">SPRING</button>
                                        <button class="reverb-type-btn" data-type="1">PLATE</button>
                                        <button class="reverb-type-btn" data-type="2">HALL</button>
                                    </div>

                                    <!-- Main Controls -->
                                    <div class="grid grid-cols-4 gap-2 mb-3">
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small reverb-knob" id="reverbSize-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="reverbSize-value">50%</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">SIZE</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small reverb-knob" id="reverbDecay-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="reverbDecay-value">50%</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">DECAY</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small reverb-knob" id="reverbDamp-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="reverbDamp-value">50%</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">DAMP</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small reverb-knob" id="reverbPreDelay-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="reverbPreDelay-value">10%</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">PRE-DLY</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stereo & Modulation Section -->
                                <div class="p-3">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="font-display text-[8px] font-bold tracking-[1px] text-fd-text-dim uppercase">STEREO & MODULATION</span>
                                    </div>
                                    <div class="grid grid-cols-3 gap-3">
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small reverb-knob" id="reverbWidth-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="reverbWidth-value">100%</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">WIDTH</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small reverb-knob" id="reverbModRate-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="reverbModRate-value">30%</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">MOD RATE</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small reverb-knob" id="reverbModDepth-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="reverbModDepth-value">20%</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">MOD DEPTH</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- DELAY Detail View -->
                            <div class="effect-detail hidden" id="delay-detail" data-effect="delay">
                                <div class="p-3 border-b border-fd-border">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <div class="section-led delay-led" id="delay-detail-led"></div>
                                            <span class="font-display text-[8px] font-bold tracking-[1px] text-fd-text-dim uppercase">DELAY</span>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-4 gap-2">
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small delay-knob" id="delayTime-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="delayTime-value">300ms</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">TIME</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small delay-knob" id="feedback-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="feedback-value">40%</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">FDBK</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small delay-knob" id="tone-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="tone-value">4.0kHz</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">TONE</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small delay-knob" id="mix-detail-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="mix-detail-value">50%</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">MIX</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- CHARACTER Section -->
                                <div class="p-3">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="font-display text-[8px] font-bold tracking-[1px] text-fd-text-dim uppercase">CHARACTER</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-2">
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small delay-knob" id="age-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="age-value">25%</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">AGE</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small delay-knob" id="modRate-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="modRate-value">0.5Hz</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">RATE</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small delay-knob" id="modDepth-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="modDepth-value">3ms</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">DEPTH</span>
                                        </div>
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="knob knob-small delay-knob" id="warmth-knob">
                                                <div class="knob-dot"></div>
                                            </div>
                                            <span class="font-mono text-[9px] text-white" id="warmth-value">30%</span>
                                            <span class="font-display text-[7px] text-fd-text-dim">WARMTH</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- Diagnostics toggle (bottom right of effects panel) -->
                        <div class="flex justify-end p-2 border-t border-fd-border mt-auto">
                            <button class="diag-toggle-btn" id="diag-toggle" title="Toggle audio diagnostics">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 3v18h18"/>
                                    <path d="M7 16l4-8 4 6 4-10"/>
                                </svg>
                            </button>
                        </div>
                    </section>
                </div>
            </div>

        </main>

        <!-- Diagnostic Panel (floating, attached to main) -->
        <div id="diag-panel" class="hidden absolute bottom-16 left-4 bg-fd-card border border-fd-border rounded p-2 text-[9px] font-mono z-50 shadow-lg" style="min-width: 280px;">
            <div class="flex justify-between items-center mb-2">
                <span class="font-bold text-fd-accent">AUDIO DIAGNOSTICS</span>
                <button class="text-fd-text-dim hover:text-white" id="diag-reset">Reset</button>
            </div>
            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-fd-text">
                <span>Pre-Clip Peak L:</span><span id="diag-preclip-l" class="text-right">0.00</span>
                <span>Pre-Clip Peak R:</span><span id="diag-preclip-r" class="text-right">0.00</span>
                <span>Loop Output L:</span><span id="diag-loop-l" class="text-right">0.00</span>
                <span>Loop Output R:</span><span id="diag-loop-r" class="text-right">0.00</span>
                <span class="text-yellow-400">Clip Events:</span><span id="diag-clips" class="text-right text-yellow-400">0</span>
            </div>
            <div class="mt-2 pt-2 border-t border-fd-border">
                <span class="text-fd-text-dim">Layer Clips:</span>
                <div class="flex gap-1 mt-1" id="diag-layer-clips">
                    <span class="px-1 bg-fd-surface rounded">1:0</span>
                    <span class="px-1 bg-fd-surface rounded">2:0</span>
                    <span class="px-1 bg-fd-surface rounded">3:0</span>
                    <span class="px-1 bg-fd-surface rounded">4:0</span>
                    <span class="px-1 bg-fd-surface rounded">5:0</span>
                    <span class="px-1 bg-fd-surface rounded">6:0</span>
                    <span class="px-1 bg-fd-surface rounded">7:0</span>
                    <span class="px-1 bg-fd-surface rounded">8:0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed position dropdown menus for SPEED and PITCH -->
    <select class="chromatic-menu" id="speed-preset-select">
        <option value="0.25">-24st (1/4x)</option>
        <option value="0.2649">-23st</option>
        <option value="0.2806">-22st</option>
        <option value="0.2973">-21st</option>
        <option value="0.3150">-20st</option>
        <option value="0.3337">-19st</option>
        <option value="0.3536">-18st</option>
        <option value="0.3746">-17st</option>
        <option value="0.3969">-16st</option>
        <option value="0.4204">-15st</option>
        <option value="0.4454">-14st</option>
        <option value="0.4719">-13st</option>
        <option value="0.5">-12st (1/2x)</option>
        <option value="0.5297">-11st</option>
        <option value="0.5612">-10st</option>
        <option value="0.5946">-9st</option>
        <option value="0.6300">-8st</option>
        <option value="0.6674">-7st</option>
        <option value="0.7071">-6st</option>
        <option value="0.7492">-5st</option>
        <option value="0.7937">-4st</option>
        <option value="0.8409">-3st</option>
        <option value="0.8909">-2st</option>
        <option value="0.9439">-1st</option>
        <option value="1.0" selected>0st (1x)</option>
        <option value="1.0595">+1st</option>
        <option value="1.1225">+2st</option>
        <option value="1.1892">+3st</option>
        <option value="1.2599">+4st</option>
        <option value="1.3348">+5st</option>
        <option value="1.4142">+6st</option>
        <option value="1.4983">+7st</option>
        <option value="1.5874">+8st</option>
        <option value="1.6818">+9st</option>
        <option value="1.7818">+10st</option>
        <option value="1.8877">+11st</option>
        <option value="2.0">+12st (2x)</option>
        <option value="2.1189">+13st</option>
        <option value="2.2449">+14st</option>
        <option value="2.3784">+15st</option>
        <option value="2.5198">+16st</option>
        <option value="2.6697">+17st</option>
        <option value="2.8284">+18st</option>
        <option value="2.9966">+19st</option>
        <option value="3.1748">+20st</option>
        <option value="3.3636">+21st</option>
        <option value="3.5636">+22st</option>
        <option value="3.7755">+23st</option>
        <option value="4.0">+24st (4x)</option>
    </select>

    <select class="chromatic-menu" id="pitch-select">
        <option value="-24">-24st (-2 oct)</option>
        <option value="-23">-23st</option>
        <option value="-22">-22st</option>
        <option value="-21">-21st</option>
        <option value="-20">-20st</option>
        <option value="-19">-19st</option>
        <option value="-18">-18st</option>
        <option value="-17">-17st</option>
        <option value="-16">-16st</option>
        <option value="-15">-15st</option>
        <option value="-14">-14st</option>
        <option value="-13">-13st</option>
        <option value="-12">-12st (-1 oct)</option>
        <option value="-11">-11st</option>
        <option value="-10">-10st</option>
        <option value="-9">-9st</option>
        <option value="-8">-8st</option>
        <option value="-7">-7st</option>
        <option value="-6">-6st</option>
        <option value="-5">-5st</option>
        <option value="-4">-4st</option>
        <option value="-3">-3st</option>
        <option value="-2">-2st</option>
        <option value="-1">-1st</option>
        <option value="0" selected>0st</option>
        <option value="1">+1st</option>
        <option value="2">+2st</option>
        <option value="3">+3st</option>
        <option value="4">+4st</option>
        <option value="5">+5st</option>
        <option value="6">+6st</option>
        <option value="7">+7st</option>
        <option value="8">+8st</option>
        <option value="9">+9st</option>
        <option value="10">+10st</option>
        <option value="11">+11st</option>
        <option value="12">+12st (+1 oct)</option>
        <option value="13">+13st</option>
        <option value="14">+14st</option>
        <option value="15">+15st</option>
        <option value="16">+16st</option>
        <option value="17">+17st</option>
        <option value="18">+18st</option>
        <option value="19">+19st</option>
        <option value="20">+20st</option>
        <option value="21">+21st</option>
        <option value="22">+22st</option>
        <option value="23">+23st</option>
        <option value="24">+24st (+2 oct)</option>
    </select>

    <!-- Crossfade Settings Panel (positioned relative to button) -->
    <div id="xfade-panel" class="xfade-panel hidden">
        <div class="xfade-panel-header">
            <span class="xfade-panel-title">LOOP BOUNDARY</span>
            <button class="xfade-led-toggle" id="xfade-enable-toggle" title="Enable/Disable">
                <span class="led-indicator"></span>
                <span class="led-label">ON</span>
            </button>
        </div>

        <!-- Real-time Visualizer -->
        <div class="xfade-visualizer">
            <canvas id="xfade-viz-canvas" width="280" height="60"></canvas>
            <div class="xfade-viz-labels">
                <span class="viz-label-pre">PRE</span>
                <span class="viz-label-boundary">|</span>
                <span class="viz-label-post">POST</span>
            </div>
        </div>

        <!-- Time Window (applies to both effects) -->
        <div class="xfade-section">
            <div class="xfade-section-label">FADE WINDOW</div>
            <div class="xfade-param-row">
                <label class="xfade-label">Pre (ms)</label>
                <input type="range" id="xfade-pre-time" min="5" max="500" value="80" class="xfade-slider">
                <span class="xfade-value" id="xfade-pre-time-val">80</span>
            </div>
            <div class="xfade-param-row">
                <label class="xfade-label">Post (ms)</label>
                <input type="range" id="xfade-post-time" min="5" max="500" value="100" class="xfade-slider">
                <span class="xfade-value" id="xfade-post-time-val">100</span>
            </div>
        </div>

        <!-- LP Filter (most effective, placed first) -->
        <div class="xfade-section">
            <div class="xfade-section-label">LOW-PASS FILTER</div>
            <div class="xfade-param-row">
                <label class="xfade-label">Cutoff (Hz)</label>
                <input type="range" id="xfade-filter-freq" min="0" max="100" value="0" class="xfade-slider">
                <span class="xfade-value" id="xfade-filter-freq-val">OFF</span>
            </div>
            <div class="xfade-param-row">
                <label class="xfade-label">Depth (%)</label>
                <input type="range" id="xfade-filter-depth" min="0" max="100" value="0" class="xfade-slider">
                <span class="xfade-value" id="xfade-filter-depth-val">0</span>
            </div>
        </div>

        <!-- Volume Duck -->
        <div class="xfade-section">
            <div class="xfade-section-label">VOLUME DUCK</div>
            <div class="xfade-param-row">
                <label class="xfade-label">Depth (%)</label>
                <input type="range" id="xfade-vol-depth" min="0" max="100" value="50" class="xfade-slider">
                <span class="xfade-value" id="xfade-vol-depth-val">50</span>
            </div>
        </div>
    </div>

    <script src="main.js"></script>
</body>
</html>
\